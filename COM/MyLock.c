/***************************************************************************************************
*FileName: MyLock
*Description: 一个锁，不仅仅锁文件
*Author:xsx
*Data: 2017年7月6日 16:46:23
***************************************************************************************************/

/***************************************************************************************************/
/******************************************头文件***************************************************/
/***************************************************************************************************/
#include	"MyLock.h"

/***************************************************************************************************/
/**************************************变量声明*************************************************/
/***************************************************************************************************/

/***************************************************************************************************/
/**************************************局部函数声明*************************************************/
/***************************************************************************************************/

/***************************************************************************************************/
/***************************************************************************************************/
/***************************************正文********************************************************/
/***************************************************************************************************/
/***************************************************************************************************/
/***************************************************************************************************/

/***************************************************************************************************
*FunctionName:  LockObject
*Description:  上锁
*Input:  	myLock -- 锁地址
*			ownerId -- 谁给锁上锁
*			cnt -- 等待时间（时间基数50ms）
*Output:  
*Return:  
*Author:  xsx
*Date: 2017年7月6日 17:12:27
***************************************************************************************************/
MyRes LockObject(MyLock * myLock, void * ownerId, unsigned char cnt)
{
	//锁不存在，或者要上锁的拥有者不存在，返回失败
	if((myLock == NULL) || (ownerId == NULL))
		return My_Fail;
	
	//如果已经存在拥有者，即已处于上锁的状态，则等待解锁
	while((cnt--) && (myLock->ownerId != NULL))
	{
		vTaskDelay(50 / portTICK_RATE_MS);
	}	

	//如果依然处于上锁状态，则返回失败
	if(myLock->ownerId != NULL)
		return My_Fail;
	else
	{
		myLock->ownerId = ownerId;
		return My_Pass;
	}
}

/***************************************************************************************************
*FunctionName:  UnLockObject
*Description:  解锁
*Input:  	myLock -- 锁地址
*			ownerId -- 谁解锁
*Output:  
*Return:  
*Author:  xsx
*Date: 2017年7月6日 17:14:21
***************************************************************************************************/
MyRes UnLockObject(MyLock * myLock, void * ownerId)
{
	//锁不存在，或者要解锁的人不存在，返回失败
	if((myLock == NULL) || (ownerId == NULL))
		return My_Fail;
	
	//如果处于解锁状态，则不需要解锁，返回成功
	if(myLock->ownerId == NULL)
		return My_Pass;
	
	//如果处于上锁状态，且上锁人等于解锁人，则解锁
	else if(myLock->ownerId == ownerId)
	{
		myLock->ownerId = NULL;
		return My_Pass;
	}
	
	//如果处于上锁状态，但是上锁人不等于解锁人，则无权解锁
	else
		return My_Fail;
}
/****************************************end of file************************************************/
