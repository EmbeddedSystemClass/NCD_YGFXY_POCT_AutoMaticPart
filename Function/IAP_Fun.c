/***************************************************************************************************
*FileName:IAP_Fun
*Description:IAP功能
*Author:xsx
*Data:2017年2月16日16:27:25
***************************************************************************************************/


/***************************************************************************************************/
/******************************************头文件***************************************************/
/***************************************************************************************************/
#include	"IAP_Fun.h"

#include	"RemoteSoftDao.h"
#include	"AppFileDao.h"

#include	"RemoteSoft_Data.h"

#include	"MyMem.h"
#include	"Md5.h"
#include	"Define.h"
#include	"MyTools.h"
#include	"Delay.h"

#include	<string.h>
#include	"stdio.h"
#include 	"stdlib.h"

/***************************************************************************************************/
/**************************************局部变量声明*************************************************/
/***************************************************************************************************/

/***************************************************************************************************/
/**************************************局部函数声明*************************************************/
/***************************************************************************************************/

/***************************************************************************************************/
/***************************************************************************************************/
/***************************************正文********************************************************/
/***************************************************************************************************/
/***************************************************************************************************/
/***************************************************************************************************/

/***************************************************************************************************
*FunctionName: checkMd5
*Description: 计算并对比MD5
*Input: 
*Output: 
*Return: 
*Author: xsx
*Date: 2017年2月20日14:02:35
***************************************************************************************************/
MyRes checkMd5(void)
{
	RemoteSoftInfo * remoteSoftInfo = NULL;		//读取的固件信息
	MyRes status = My_Fail;
	
	remoteSoftInfo = MyMalloc(sizeof(RemoteSoftInfo));
	if(remoteSoftInfo)
	{
		//读取文件中的md5
		memset(remoteSoftInfo, 0, sizeof(RemoteSoftInfo));
		if(My_Pass == ReadRemoteSoftInfo(remoteSoftInfo))
		{
			//计算更新固件的md5值,为节省内存，将计算后的md5保存在固件信息的desc数组内
			md5sum(remoteSoftInfo->desc);
		
			//对比MD5
			if(true == CheckStrIsSame(remoteSoftInfo->md5, remoteSoftInfo->desc, 32))
				status = My_Pass;
		}
	}
	
	MyFree(remoteSoftInfo);
	
	return status;	
}

/***************************************************************************************************
*FunctionName: checkNewFirmwareIsSuccessDownload
*Description: 检查是否成功下载新固件
*Input: 
*Output: 
*Return: 
*Author: xsx
*Date: 2017年2月21日09:02:28
***************************************************************************************************/
MyRes checkNewFirmwareIsSuccessDownload(void)
{
	//检查是否有新程序
	if(My_Pass == checkNewAppFileIsExist())
	{
		//如果有新固件，对比MD5
		return checkMd5();
	}
	
	return My_Fail;
}


